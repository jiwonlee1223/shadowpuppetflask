# Shadow Puppet AR - 실시간 형태 탐지 및 비디오 오버레이

실시간 웹캠에서 특정 형태(예: 토끼 모양)를 탐지하고, 탐지된 형태 위에 비디오를 증강현실(AR) 스타일로 오버레이하는 Flask 기반 웹 애플리케이션입니다.

## 주요 기능

### 🎯 실시간 형태 탐지
- **OpenCV Hu Moments** 기반 형태 매칭
- **적응형 임계값** 및 모폴로지 연산
- **히스테리시스 기반 잠금 메커니즘** - 깜빡임 없는 안정적 추적
- **지수 이동 평균(EMA)** - 부드러운 추적
- **⭐ 영구 활성화 모드** - 3초 이상 탐지 시 형태를 치워도 계속 재생!
- **✋ 손 드래그 인터랙션** - 손으로 토끼 애니메이션을 잡고 끌고 다닐 수 있음!

### 📹 비디오 오버레이
- **원근 변환(Perspective Transform)** - 정확한 워핑
- **곱하기 블렌드 모드** - 자연스러운 합성
- **실시간 비디오 재생** - 무한 루프

### 🎨 Photoshop 스타일 레벨 조정
- Input Black/White (입력 범위)
- Gamma 보정 (감마 값)
- Output Black/White (출력 범위)
- 조명 조건이 나쁜 환경에서도 탐지 가능

### 🔧 고급 설정
- 진입/탈출 임계값 조정
- 실시간 FPS 표시
- 잠금 상태 시각화

## 기술 스택

### 백엔드
- **Flask** - 웹 프레임워크
- **Flask-SocketIO** - 실시간 통신
- **OpenCV** - 이미지/비디오 처리
- **MediaPipe** - 손 탐지 및 추적
- **NumPy** - 수치 연산
- **Pillow** - 이미지 처리

### 프론트엔드
- **HTML5** - Canvas, Video API
- **JavaScript** - MediaStream API, Socket.IO
- **Bootstrap 5** - UI 프레임워크
- **Font Awesome** - 아이콘

## 설치 방법

### 1. 저장소 클론 또는 다운로드

```bash
cd shadowpuppetflask
```

### 2. 가상 환경 생성 (선택 사항)

**Windows:**
```bash
python -m venv venv
venv\Scripts\activate
```

**macOS/Linux:**
```bash
python3 -m venv venv
source venv/bin/activate
```

### 3. 의존성 설치

```bash
pip install -r requirements.txt
```

### 4. 필수 파일 준비

`files/` 폴더에 다음 파일을 추가해야 합니다:

- **rabbit reference.png** - 탐지할 형태의 참조 이미지
- **rabbit bg.mov** - 오버레이할 비디오 파일

> **참고:** 이 파일들이 없으면 애플리케이션이 실행되지만 탐지 기능이 작동하지 않습니다.

## 사용 방법

### 1. 가상환경 활성화 (가상환경을 생성한 경우)

설치 단계에서 가상환경을 생성했다면, 먼저 가상환경을 활성화해야 합니다.

**Windows:**
```bash
cd shadowpuppetflask
.\venv\Scripts\Activate.ps1
```

**macOS/Linux:**
```bash
cd shadowpuppetflask
source venv/bin/activate
```

가상환경이 활성화되면 터미널 프롬프트 앞에 `(venv)`가 표시됩니다.

### 2. 서버 실행

```bash
python app.py
```

서버가 시작되면 다음과 같은 메시지가 표시됩니다:

```
============================================================
Shadow Puppet AR - 실시간 형태 탐지 및 비디오 오버레이
============================================================

시스템 초기화 중...
✓ 형태 감지기 초기화 완료
✓ 비디오 오버레이 초기화 완료

서버 시작...
브라우저에서 http://localhost:5000 을 열어주세요.
============================================================
```

### 3. 웹 브라우저에서 접속

브라우저에서 `http://localhost:5000` 을 엽니다.

### 4. 웹캠 권한 허용

브라우저에서 웹캠 접근 권한을 요청하면 **허용**을 클릭합니다.

### 5. 실시간 탐지 시작

1. **"시작"** 버튼을 클릭합니다.
2. 참조 이미지와 비슷한 형태를 웹캠에 보여줍니다.
3. 형태가 탐지되면 자동으로 비디오가 오버레이됩니다.

### 6. 레벨 조정 (선택 사항)

조명이 좋지 않거나 탐지가 잘 안 되면 **레벨 조정** 패널을 사용합니다:

- **Input Black**: 입력 검은색 포인트를 높입니다 (어두운 부분 제거)
- **Input White**: 입력 흰색 포인트를 낮춥니다 (밝은 부분 제거)
- **Gamma**: 감마 값을 조정합니다 (중간 톤 조정)

### 7. 임계값 조정 (선택 사항)

탐지 민감도를 조정하려면:

- **진입 임계값**: 낮을수록 더 엄격 (기본값: 0.25)
- **탈출 임계값**: 높을수록 더 관대 (기본값: 0.50)

## 프로젝트 구조

```
shadowpuppetflask/
├── app.py                    # Flask 메인 애플리케이션
├── shape_detector.py         # 형태 탐지 클래스
├── video_overlay.py          # 비디오 오버레이 클래스
├── requirements.txt          # 의존성 목록
├── README.md                 # 이 파일
├── static/
│   ├── css/
│   │   └── style.css        # 커스텀 스타일시트
│   ├── js/
│   │   ├── main.js          # 메인 JavaScript
│   │   └── socket-handler.js # WebSocket 핸들러
│   └── images/              # 정적 이미지
├── templates/
│   ├── layout.html          # 레이아웃 템플릿
│   └── index.html           # 메인 페이지
├── files/
│   ├── rabbit reference.png # 참조 이미지 (사용자 제공)
│   └── rabbit bg.mov        # 오버레이 비디오 (사용자 제공)
└── uploads/                 # 사용자 업로드 (선택)
```

## 알고리즘 설명

### 형태 탐지 알고리즘

1. **전처리**
   - 그레이스케일 변환
   - 가우시안 블러 (노이즈 제거)
   - 레벨 조정 (선택적)

2. **이진화**
   - 적응형 임계값 (Adaptive Threshold)
   - 모폴로지 연산 (Close + Open)

3. **윤곽선 추출**
   - `cv2.findContours()`
   - 면적 및 종횡비 필터링

4. **형태 매칭**
   - Hu Moments 계산
   - `cv2.matchShapes()` - CONTOURS_MATCH_I3

5. **히스테리시스**
   - 좋은 매칭 12번 연속 → 잠금 활성화
   - 나쁜 매칭 8번 연속 → 잠금 해제

6. **부드러운 추적**
   - 지수 이동 평균(EMA) 적용
   - 중심점, 각도, 스케일 스무딩

### 비디오 오버레이 알고리즘

1. **프레임 코너 계산**
   - 참조 이미지 비율 사용
   - 상단:토끼:하단 = 100:294:38
   - 좌:토끼:우 = 207:364:200

2. **원근 변환**
   - 소스: 비디오 4개 코너
   - 목적지: 탐지된 형태의 프레임 코너
   - `cv2.getPerspectiveTransform()`

3. **워핑 및 합성**
   - `cv2.warpPerspective()`
   - 곱하기 블렌드: `(base * video) / 255`

## 문제 해결

### 웹캠이 작동하지 않음
- 브라우저 설정에서 웹캠 권한을 확인합니다.
- HTTPS 또는 localhost에서만 웹캠 접근이 가능합니다.

### 형태가 탐지되지 않음
1. **레벨 조정**을 사용하여 대비를 높입니다.
2. **진입 임계값**을 높여 더 관대하게 만듭니다 (예: 0.35).
3. 조명을 개선합니다.
4. 참조 이미지와 실제 형태가 충분히 유사한지 확인합니다.

### 탐지가 불안정함 (깜빡임)
1. **탈출 임계값**을 높입니다 (예: 0.60).
2. 카메라를 고정하여 흔들림을 줄입니다.
3. 형태를 더 명확하게 보여줍니다.

### FPS가 낮음
1. 웹캠 해상도를 낮춥니다 (`main.js`에서 조정).
2. 더 빠른 컴퓨터를 사용합니다.
3. 비디오 품질을 낮춥니다.

## 라이선스

이 프로젝트는 교육 목적으로 제공됩니다.

## 기여

버그 리포트, 기능 제안, Pull Request를 환영합니다!

---

**Shadow Puppet AR** - 실시간 형태 탐지와 증강현실의 만남 🎭✨

